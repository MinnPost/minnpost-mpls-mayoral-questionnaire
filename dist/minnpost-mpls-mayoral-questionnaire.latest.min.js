/*! MinnPost Minneapolis Mayoral questionnaire - v0.0.1 - 2013-10-23
* https://github.com/minnpost/minnpost-mpls-mayoral-questionnaire
* Copyright (c) 2013 MinnPost; Licensed MIT */

var mpApps=mpApps||{},mpTemplates=mpTemplates||{};mpTemplates["minnpost-mpls-mayoral-questionnaire"]=mpTemplates["minnpost-mpls-mayoral-questionnaire"]||{};var mpData=mpData||{};mpData["minnpost-mpls-mayoral-questionnaire"]=mpData["minnpost-mpls-mayoral-questionnaire"]||{},_.mixin({formatNumber:function(a,b){b=_.isUndefined(b)?2:b;var c=/(\d+)(\d{3})/;for(split=a.toFixed(b).toString().split(".");c.test(split[0]);)split[0]=split[0].replace(c,"$1,$2");return b?split[0]+"."+split[1]:split[0]},formatCurrency:function(a){return"$"+_.formatNumber(a,2)},formatPercent:function(a){return _.formatNumber(100*a,1)+"%"},formatPercentChange:function(a){return(a>0?"+":"")+_.formatPercent(a)}}),function(a){App=mpApps["minnpost-mpls-mayoral-questionnaire"]=function(b){this.options=_.extend(this.defaultOptions,b),this.$el=a(this.options.el),this.templates=mpTemplates["minnpost-mpls-mayoral-questionnaire"]||{},this.data=mpData["minnpost-mpls-mayoral-questionnaire"]||{},this.id=_.uniqueId("mp-")},_.extend(App.prototype,{extend:Backbone.Model.extend,defaultOptions:{dataPath:"./data/",imagePath:"./css/images/",jsonpProxy:"http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",localStorageKey:_.uniqueId("minnpost-mpls-mayoral-questionnaire-")},getTemplates:function(b){var c=this,d=[];return b=_.isArray(b)?b:[b],_.each(b,function(b){var e,f="js/templates/"+b+".mustache";_.isUndefined(c.templates[b])&&(e=a.ajax({url:f,method:"GET",async:!1,contentType:"text"}),a.when(e).done(function(a){c.templates[b]=a}),d.push(e))}),a.when.apply(a,d)},template:function(a){return this.templates[a]},getLocalData:function(b){var c=this,d=this.options.jsonpProxy,e=!1,f=[];return b=_.isArray(b)?b:[b],this.options&&0===this.options.dataPath.indexOf("http")&&(e=!0),_.each(b,function(b){var g;b+=".json",_.isUndefined(c.data[b])?(g=e?a.jsonp({url:d+encodeURI(c.options.dataPath+b)}):a.getJSON(c.options.dataPath+b),a.when(g).done(function(a){c.data[b]=a}),f.push(g)):(g=a.Deferred(),g.resolveWith(c,[c.data[b]]),f.push(g))}),a.when.apply(a,f)},getRemoteData:function(b){return this.options.remoteProxy?(b.url=b.url+"&callback=proxied_jqjsp",b.url=app.options.remoteProxy+encodeURIComponent(b.url),b.callback="proxied_jqjsp",b.cache=!0):b.url=b.url+"&callback=?",a.jsonp(b)},start:function(){}})}(jQuery),mpData=mpData||{},mpData["minnpost-mpls-mayoral-questionnaire"]=mpData["minnpost-mpls-mayoral-questionnaire"]||{},mpData["minnpost-mpls-mayoral-questionnaire"]["questions_answers.json"]={"2013 Mayoral Questionnaire":{answers:[{id:1,candidate:"Mark Andrew",image:"MarkAndrew250.png","summary-1":"sdfsdfds","question-1":"answer here M 1","summary-2":"sdfdsf","question-2":"answer here M 2","summary-3":"sdlkfjsdf","question-3":"answer here M 3","question-4":"answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  answer here.  ","question-5":"answer here M 3",rowNumber:1},{id:2,candidate:"Ron Samuels",image:"DonSamuels250.png","summary-1":"sdfsdfds","question-1":"answer here R 1","summary-2":"sdfdsf","question-2":"answer here R 2","summary-3":"ssssssssss","question-3":"answer here R 3","question-4":"answer here R 3","question-5":"answer here R 3",rowNumber:2},{id:3,candidate:"Besty Hodges",image:"BetsyHodges250.png","summary-1":"a","question-1":"aaa","summary-2":"","question-2":"","summary-3":"","question-3":"","question-4":"","question-5":"",rowNumber:3},{id:4,candidate:"Bob Fine",image:"BobFine250.png","summary-1":"b","question-1":"bbbb","summary-2":"","question-2":"","summary-3":"","question-3":"","question-4":"","question-5":"",rowNumber:4},{id:5,candidate:"Cam Winton",image:"CamWinton250.png","summary-1":"c","question-1":"","summary-2":"","question-2":"","summary-3":"","question-3":"","question-4":"","question-5":"",rowNumber:5},{id:6,candidate:"Dan Cohen",image:"dancohen250.jpg","summary-1":"d","question-1":"","summary-2":"","question-2":"","summary-3":"","question-3":"","question-4":"","question-5":"",rowNumber:6},{id:7,candidate:"Gary Schiff",image:"GarySchiff250.png","summary-1":"e","question-1":"","summary-2":"","question-2":"","summary-3":"","question-3":"","question-4":"","question-5":"",rowNumber:7},{id:8,candidate:"Jackie Cherryhomes",image:"JackieCherryhomes250.png","summary-1":"f","question-1":"","summary-2":"","question-2":"","summary-3":"","question-3":"","question-4":"","question-5":"",rowNumber:8},{id:9,candidate:"Jim Thomas",image:"JimThomas250.png","summary-1":"g","question-1":"","summary-2":"","question-2":"","summary-3":"","question-3":"","question-4":"","question-5":"",rowNumber:9},{id:10,candidate:"Stephanie Woodruff",image:"StephanieWoodruff250.png","summary-1":"h","question-1":"","summary-2":"","question-2":"","summary-3":"","question-3":"","question-4":"","question-5":"",rowNumber:10}],questions:[{id:1,shortname:"Closing the Gap",question:'In this campaign we have heard frequent references to the gaps that separate Minneapolis residents in terms of education, employment and housing.  Explain how you, as mayor, will work to eliminate one of these gaps. (<a href="http://www.minnpost.com/learning-curve/2013/03/reset-effort-focuses-achievement-gap-and-shows-ways-close-it">Learn more</a>)',rowNumber:1},{id:2,shortname:"Property Taxes",question:'What would you do as mayor to prevent yearly increases in property taxes? (<a href="http://www.startribune.com/politics/statelocal/228488671.html">Learn more</a>)',rowNumber:2},{id:3,shortname:"Vikings Stadium",question:'With continuing opposition to the funding and process surrounding construction of the Vikings stadium, how would you proceed both in terms of bringing the community together and ensuring that future development in that area benefits all of Minneapolis? (<a href="http://www.minnpost.com/cityscape/2013/08/sorting-out-ins-and-outs-downtown-east">Learn more</a>)',rowNumber:3},{id:4,shortname:"Police Chief",question:'After a year of high-profile controversies, what would you do as mayor to bring change to the Police Department, and are you likely to retain Janee Harteau as police chief?  Why? (<a href="http://www.minnpost.com/two-cities/2013/05/minneapolis-officials-back-police-chief-harteau-s-limited-comments-friday-events">Learn more</a>)',rowNumber:4},{id:5,shortname:"SWLRT",question:'When you take office, one of your first key decisions may involve the controversial Southwest LRT line. What will you do to help influence the final route and its impact on city neighborhoods? And what will you do if you are unhappy with the route selected? (<a href="http://www.minnpost.com/politics-policy/2013/10/mayor-rybak-calls-intense-study-southwest-lrt-options-during-90-day-delay">Learn more</a>) ',rowNumber:5},{id:6,shortname:"Streetcars",question:'Do you favor streetcars or expanded bus service for the proposed Nicollet/Central transit route -- and why? What’s your overall transit philosophy for the city? (<a href="http://www.minnpost.com/politics-policy/2013/09/streetcars-endorsed-minneapolis-central-nicollet-transit-line">Learn more</a>)  ',rowNumber:6},{id:7,shortname:"Education",question:"With the schools and achievement gap emerging as major issues in the mayor’s race, what's the most surprising thing you've learned about education since you began campaigning, and how might it change your thinking? (<a href=\"http://www.minnpost.com/learning-curve/2013/08/why-minneapolis-mayoral-candidates-are-making-strong-schools-such-big-issue\">Learn more</a>)",rowNumber:7},{id:8,shortname:"Orchestra Lockout",question:'With the resignation of musical director Osmo Vänskä and the newly remodeled Orchestra Hall vacant and silent, what would you do as mayor to help resolve the dispute if the lockout is still in effect in January?  (<a href="http://www.minnpost.com/politics-policy/2013/09/politicians-frustrated-too-orchestra-dispute-approaches-do-or-die-weekend">Learn more</a>)',rowNumber:8}]}},mpTemplates=mpTemplates||{},mpTemplates["minnpost-mpls-mayoral-questionnaire"]={"template-application":'<div class="grid-container grid-parent {{ (canStore) ? \'can-store\' : \'\' }}">\n  <div class="grid-100 message-container"></div>\n\n  <div class="grid-100 grid-parent content-container"></div>\n\n  <div class="grid-100 grid-parent footnote-container"></div>\n</div>',"template-candidates":'<div class="question-menu grid-20 mobile-grid-20 tablet-grid-20">\n  <div class="question-menu-inner">\n    <h5>Issues</h5>\n\n    <ul>\n      {{#questions:q}}\n        <li><a href="#question-{{ id }}" on-tap="slideTo:{{ id }}">{{ shortname }}</a></li>\n      {{/questions}}\n    </ul>\n\n    <h5>Candidates</h5>\n\n    <ul>\n      {{#candidates:c}}\n        <li>{{ starred }} &mdash; {{ candidate }}</li>\n      {{/candidates}}\n    </ul>\n  </div>\n</div>\n\n<div class="candidates-questions-answers grid-80 mobile-grid-80 tablet-grid-80">\n  {{#questions:q}}\n    <div class="question grid-100 grid-parent" id="question-{{ id }}">\n      <p class="question-text"><span class="question-title">{{ shortname }}:</span> {{{ question }}}</p>\n\n      {{#answers:a}}\n        <div class="answer grid-50" id="answer-{{ q }}-{{ a }}">\n          <div class="answer-inner">\n            <div class="answer-image"><img src="{{ imagePath }}{{ image }}" /></div>\n            <div class="star {{ (starred) ? \'starred\' : \'\' }}" on-tap="star:{{ q }},{{ a }}">★</div>\n\n            <h5>{{ candidate }}</h5>\n\n            <div class="summary-answer">\n              <p class="summary-text"><strong>Summary</strong>: {{ summary }}</p>\n\n              {{#answer}}\n                <a class="read-more" href="read-more-{{ q }}-{{ a }}" on-tap="readMore:{{ q }},{{ a }}">Read more</a>\n                <p class="answer-text">{{ answer }}</p>\n              {{/answer}}\n            </div>\n          </div>\n        </div>\n      {{/answers}}\n    </div>\n  {{/questions}}\n</div>',"template-footnote":'<div class="footnote">\n  <p>Candidate answers were recieved via a questionnaire that MinnPost sent to candidates.  <span class="remove-local-storage">Your preferences are stored locally on your browser, and for your own privacy, you can <a class="remove-storage" on-tap="removeStorage" href="#remove">remove the local data</a>.</span>  Some code, techniques, and data on <a href="https://github.com/zzolo/minnpost-mpls-mayoral-questionnaire" target="_blank">Github</a>.</p>\n</div>',"template-loading":'<div class="loading-container">\n  <div class="loading"><span>Loading...</span></div>\n</div>'},function(a,b,c){_.extend(a.prototype,{start:function(){var b=this,c=["template-application","template-footnote","template-candidates","template-loading"];this.checkCanStore(),this.getTemplates(c).done(function(){b.applicationView=new a.prototype.ApplicationView({el:b.$el,template:b.template("template-application"),data:{canStore:b.canStore}}),b.footnoteView=new a.prototype.FootnoteView({el:b.$el.find(".footnote-container"),template:b.template("template-footnote")}),b.footnoteView.app=b,b.getLocalData(["questions_answers"]).done(function(c){var d=[];answers=c["2013 Mayoral Questionnaire"].answers,questions=c["2013 Mayoral Questionnaire"].questions,b.questions=b.fetch(),_.each(questions,function(a){var b="question-"+a.id,c="summary-"+a.id;a.answers=[],_.each(answers,function(d){var e={};e.answer=d[b],e.summary=d[c],_.each(d,function(a,b){0!==b.indexOf("question")&&0!==b.indexOf("summary")&&(e[b]=a)}),a.answers.push(e)}),d.push(a)}),_.isUndefined(b.questions)?(b.questions=new a.prototype.QuestionsCollection(d),b.save()):b.invalidateLocalStorage(d),b.aggregateCandidates(),b.candidatesView=new a.prototype.CandidatesView({el:b.$el.find(".content-container"),template:b.template("template-candidates"),data:{candidates:b.candidates,questions:b.questions,imagePath:b.options.imagePath},adaptors:["Backbone"]}),b.candidatesView.app=b})})},aggregateCandidates:function(){var b=this;_.isObject(this.candidates)||(this.candidates=new a.prototype.CandidatesCollection),this.questions.each(function(c){_.each(c.get("answers"),function(c){var d=b.candidates.get(c.id);_.isUndefined(d)&&(d=new a.prototype.CandidateModel(c),b.candidates.add(d))})}),this.candidates.each(function(a){var c=0;b.questions.each(function(b){_.each(b.get("answers"),function(b){b.starred&&b.id===a.id&&c++})}),a.set("starred",c)})},checkCanStore:function(){var a="modernizr";try{return localStorage.setItem(a,a),localStorage.removeItem(a),this.canStore=!0,!0}catch(b){return this.canStore=!1,!1}},save:function(){this.canStore&&localStorage.setItem(this.options.localStorageKey,JSON.stringify(this.questions))},fetch:function(){var b;return this.canStore?(b=localStorage.getItem(this.options.localStorageKey),b?new a.prototype.QuestionsCollection(JSON.parse(b)):c):c},destroy:function(){return this.canStore?localStorage.removeItem(this.options.localStorageKey):void 0},invalidateLocalStorage:function(b){var c=!1,d=JSON.parse(JSON.stringify(this.questions));_.size(d)==_.size(b)&&_.isEqual(_.pluck(d,"question"),_.pluck(b,"question"))||(c=!0),_.each(b,function(a,b){_.each(a.answers,function(a,e){(a.answer!==d[b].answers[e].answer||a.summary!==d[b].answers[e].summary)&&(c=!0)})}),c&&(this.questions=new a.prototype.QuestionsCollection(b),this.save())}}),a.prototype.CandidateModel=Backbone.Model.extend({}),a.prototype.QuestionModel=Backbone.Model.extend({}),a.prototype.CandidatesCollection=Backbone.Collection.extend({model:a.prototype.CandidateModel}),a.prototype.QuestionsCollection=Backbone.Collection.extend({model:a.prototype.QuestionModel}),a.prototype.ApplicationView=Ractive.extend({}),a.prototype.FootnoteView=Ractive.extend({init:function(){this.on("removeStorage",function(a){a.original.preventDefault(),this.app.destroy()})}}),a.prototype.CandidatesView=Ractive.extend({init:function(){this.sidebar(),this.on("star",function(a){a.original.preventDefault();var b=this.get(a.keypath+".starred");this.set(a.keypath+".starred",b?!1:!0),this.app.aggregateCandidates(),this.app.save()}),this.on("readMore",function(a,c){a.original.preventDefault();var d=c.split(",")[0],e=c.split(",")[1],f=b(this.el).find("#answer-"+d+"-"+e);f.find(".read-more, .summary-text").fadeOut(function(){f.find(".answer-text").slideDown()})}),this.on("slideTo",function(a,c){a.original.preventDefault();var d=b(this.el).find("#question-"+c).offset().top;b("html, body").animate({scrollTop:d-15},750)})},sidebar:function(){var a=b(".question-menu"),c=a.width();a.stick_in_parent({offset_top:10}),a.on("sticky_kit:stick",function(){b(this).width(c)})}})}(mpApps["minnpost-mpls-mayoral-questionnaire"],jQuery);